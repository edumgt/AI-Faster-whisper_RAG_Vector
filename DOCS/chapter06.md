# Chapter 06. 분석 엔진(rule-based + LLM 하이브리드)

## 1) 분석 엔진 개요
`src/analysis.py`는 두 가지 모드를 가집니다.
- `analyze_rule_based`: 키워드 기반 규칙 분석
- `analyze_with_llm`: LLM 구조화 출력 분석

`analyze()`는 LLM 우선 시도 후 실패하면 규칙 기반으로 자동 대체합니다.

---

## 2) 규칙 기반 로직 핵심

### 위험도 산정
- 기본값: 0.10
- 고위험 키워드(자해/극단 표현 등) 감지 시: 최대 0.85
- 중위험 키워드(절망/불안/우울 등) 감지 시: 최대 0.35

### 감정/기분 분류
- 분노, 불안, 우울 키워드 그룹을 스캔
- 다중 감정 동시 감지 시 `mixed`

### 갈등요인 추정
- 회사/회의/상사 → 직장 갈등
- 가족/부모/집 → 가족 갈등
- 연인 키워드 → 관계 갈등

---

## 3) LLM 분석 시 스키마 가이드
LLM에는 `SYSTEM_PROMPT`와 `SCHEMA_HINT`를 같이 전달하여 JSON 형태를 유도합니다.
그 후 `AnalysisResult.model_validate()`로 마지막 안전장치를 적용합니다.

---

## 4) 예시 비교
입력:
> "요즘 회사 회의만 들어가면 숨이 막히고, 제가 쓸모없는 사람 같아요."

- 규칙 기반 예상
  - mood: anxious 또는 mixed
  - risk_score: 0.35
  - conflict_factors: ["직장/업무 갈등"]
- LLM 모드
  - 맥락 기반으로 좀 더 풍부한 `next_questions`/`coping_resources` 생성 가능

---

## 5) 개선 아이디어
1. 키워드 기반을 문장 임베딩 분류기로 확장
2. 위험도 캘리브레이션(데이터 기반)
3. 분석 근거 문장(span) 추출 추가
